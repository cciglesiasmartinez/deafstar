<!-- Page for client administration -->
<!DOCTYPE html>
<html>
<head>
  <!-- Header content, charsets, title and CSS styles-->
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/stylesheets/main_stylesheet.css" />
  <link rel="stylesheet" href="/stylesheets/cassie.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <title>Client Info</title>
</head>
<body class="flex flex-auto flex-row justify-start items-center font-sans h-screen">



  <!-- STARTS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <!-- STARTS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <!-- STARTS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <!-- STARTS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <div id="unfold__accordion-icon__container" class="unfold__accordion-icon__container--unfolded" >
    <span id="unfold_accordion_icon--close" onclick="showMenu()"><i class="fa-solid fa-xmark"></i></span>
    <span id="unfold_accordion_icon--open"  class="hideMenu" onclick="showMenu()"><i class="fa-sharp fa-solid fa-gear fa-xl"></i></span>
  </div>
  <div id="chat-screen__left-half" class="flex flex-auto flex-col justify-start items-center font-sans h-screen">
            <!-- START OF TABS CONTAINER -->
            <div id="tabs-panel__container">
              <div id="tabs-panel__outer-wrapper">
                <!-- START OF TABS ROW WRAPPER -->
                <div id="tabs-panel__tabs-wrapper">
                  <!-- START OF A TAB -->
                  <div class="tabs-panel__tab" id="tab-1" onclick="openTab('tabs-content-1')">
                    <span class="tabs-panel__tab-text"> 
                      <span class="tabs-panel__tab-icon"><i class="fa-solid fa-sliders"></i></span>User settings</span>
                  </div>
                  <!-- END OF A TAB -->
                  <!-- START OF A TAB -->
                  <div class="tabs-panel__tab" id="tab-2" onclick="openTab('tabs-content-2')">
                    <span class="tabs-panel__tab-text"> 
                      <span class="tabs-panel__tab-icon"><i class="fa-solid fa-floppy-disk"></i></span>Saved chats</span>
                  </div>
                  <!-- END OF A TAB -->
                  <!-- START OF A TAB -->
                  <div class="tabs-panel__tab" id="tab-3" onclick="openTab('tabs-content-3')">
                    <span class="tabs-panel__tab-text"> 
                      <span class="tabs-panel__tab-icon"><i class="fa-solid fa-book"></i></span>Knowledge</span>
                  </div>
                  <!-- END OF A TAB -->
                  <!-- START OF A TAB -->
                  <div class="tabs-panel__tab" id="tab-3" onclick="openTab('tabs-content-4')">
                    <span class="tabs-panel__tab-text"> 
                      <span class="tabs-panel__tab-icon"><i class="fa-solid fa-screwdriver-wrench"></i></span>Admin</span>
                  </div>
                  <!-- END OF A TAB -->
                </div><!--END OF TABS ROW WRAPPER -->
                <div id="tabs-panel__tabs-content--wrapper">
                  <div id="tabs-content-1" class="tabs-panel__tabs-content">
                    <!-- START OF USER SETTINGS CONTAINER -->
  <!-- Upper panel with client info, crawl options, and logout button -->
  <div id="upper_panel__container" class="w-2/5 mt-8 flex flex-row justify-start items-start p-2 mb-5 rounded-lg border bg-gray-600">
    <div id="client-panel__container" class="h-full w-3/5  flex flex-row justify-start items-start ">
      <!-- Client info -->
      <div id="client-panel__data" class="flex flex-col justify-start items-start">
        <!-- <h1 class="text-2xl mb-1"  >Client Info</h1> -->
        <p class="p-1"><b>Name: </b> <%- data.user.name %> <b>URL:</b> <%- data.user.url %></p>
        <!-- Crawl web controls -->
        <div id="chatControl">
          <form id="crawlForm" method="POST" class="p-1" action="/crawl">
            <label for="url"><b>URL:</b></label>
            <input id="url" type="text" placeholder=" Write URL..." name="url" style="border-radius: 5px">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="crawlButton" type="submit">Crawl!</button>
          </form>
        </div>
        <!--Chatbot system msg controls-->
        <div id="chatSystem">
          <form id="chatSystemForm" class="p-1" method="POST" action="/system">
            <label for="url"><b>System message:</b></label>
            <input id="url" type="text" placeholder="Write here..." name="url" style="border-radius: 5px">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="chatSystemButton" type="submit">Set!</button>
          </form>
        </div>
        <p class="p-1"><b>Actual message is:</b> <%- data.user.systemMsg %></p>
        <!-- Chatbot temperature adjustment -->
        <div id="chatTemperature">
          <form id="chatTemperatureForm" class="p-1" method="POST" action="/temp">
            <label for="url"><b>Temperature:</b></label>
            <input id="url" type="text" placeholder="Write here..." name="url" style="border-radius: 5px">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="chatTemperatureButton" type="submit">Set!</button>
          </form>
        </div>
        <p class="p-1"><b>Actual temperature is:</b> <%- data.user.temp %></p>
        <!-- Chatbot greet message -->
        <div id="chatGreetMsg">
          <form id="chatSystemForm" class="p-1" method="POST" action="/greetMsg">
            <label for="url"><b>Chatbot greet message:</b></label>
            <input id="url" type="text" placeholder="Write here..." name="url" style="border-radius: 5px">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="chatSystemButton" type="submit">Set!</button>
          </form>
        </div>
        <p class="p-1"><b>Actual greet message is:</b> <%- data.user.greetMsg %></p>
        <!-- Chatobt URL suggestions text -->
        <div id="chatUrlSuggestionsText">
          <form id="chatSystemForm" class="p-1" method="POST" action="/urlSuggestionsText">
            <label for="url"><b>Text for URL suggestions:</b></label>
            <input id="url" type="text" placeholder="Write here..." name="url" style="border-radius: 5px">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="chatSystemButton" type="submit">Set!</button>
          </form>
        </div>
        <p class="p-1"><b>Actual text for URL suggestions is:</b> <%- data.user.urlSuggestionsText %></p>
        <!-- Once website has been crawled, here is the generated link -->
        <% if ( data.user.chatbot !== undefined ) { %> 
          <p class="p-1">Click <a class="chatbot__link" target="_blank" href="http://<%= data.hostname %>/chat/<%= data.user.chatbot.chatId %>"> here </a> for your chatbot link.</a></p>
        <% } %>
      </div>
    </div>
    <!-- Logout Button -->
    <div id="client-panel__controls" class="h-full w-2/4 flex flex-row justify-end items-center">
      <div id="logout" >
        <form method="GET" action="/logout">
          <button type="submit" class="bg-green-500 hover:bg-green-900 text-white font-bold py-2 px-4 rounded" >Logout</button>
        </form>
      </div>
    </div>
  </div><!-- END OF USER SETTINGS CONTAINER -->
                  </div>
                  <div id="tabs-content-2" class="tabs-panel__tabs-content">
                    <div class="tab-content__wrapper">
                      <!-- SAVED CHAT EXAMPLE -->
                      <div class="saved-chat--example">
                        <div class="saved-chat--example__title">
                          <span>Ideas for new services</span>
                        </div>
                        <div class="saved-chat--example__icons">
                          <span><i class="fa-solid fa-share-nodes fa-xl"></i></span>
                          <span><i class="fa-solid fa-gear fa-xl"></i></span>
                          <span class="thrash_icon"><i class="fa-solid fa-trash fa-xl"></i></span>
                        </div>
                      </div><!-- END OF SAVED CHAT EXAMPLE -->
                      <!-- SAVED CHAT EXAMPLE -->
                      <div class="saved-chat--example">
                        <div class="saved-chat--example__title">
                          <span>Pricing questions</span>
                        </div>
                        <div class="saved-chat--example__icons">
                          <span><i class="fa-solid fa-share-nodes fa-xl"></i></span>
                          <span><i class="fa-solid fa-gear fa-xl"></i></span>
                          <span class="thrash_icon"><i class="fa-solid fa-trash fa-xl"></i></span>
                        </div>
                      </div><!-- END OF SAVED CHAT EXAMPLE -->
                      <!-- SAVED CHAT EXAMPLE -->
                      <div class="saved-chat--example">
                        <div class="saved-chat--example__title">
                          <span>Possible uses of new tool</span>
                        </div>
                        <div class="saved-chat--example__icons">
                          <span><i class="fa-solid fa-share-nodes fa-xl"></i></span>
                          <span><i class="fa-solid fa-gear fa-xl"></i></span>
                          <span class="thrash_icon" ><i class="fa-solid fa-trash fa-xl"></i></span>
                        </div>
                      </div><!-- END OF SAVED CHAT EXAMPLE -->
                      <!-- SAVED CHAT EXAMPLE -->
                      <div class="saved-chat--example">
                        <div class="saved-chat--example__title">
                          <span>Effects of microplastics on fish</span>
                        </div>
                        <div class="saved-chat--example__icons">
                          <span><i class="fa-solid fa-share-nodes fa-xl"></i></span>
                          <span><i class="fa-solid fa-gear fa-xl"></i></span>
                          <span class="thrash_icon" ><i class="fa-solid fa-trash fa-xl"></i></span>
                        </div>
                      </div><!-- END OF SAVED CHAT EXAMPLE -->
                      <!-- SAVED CHAT EXAMPLE -->
                      <div class="saved-chat--example">
                        <div class="saved-chat--example__title">
                          <span>How to culture plant cells</span>
                        </div>
                        <div class="saved-chat--example__icons">
                          <span><i class="fa-solid fa-share-nodes fa-xl"></i></span>
                          <span><i class="fa-solid fa-gear fa-xl"></i></span>
                          <span class="thrash_icon"><i class="fa-solid fa-trash fa-xl"></i></span>
                        </div>
                      </div><!-- END OF SAVED CHAT EXAMPLE -->
                      <!-- SAVED CHAT EXAMPLE -->
                      <div class="saved-chat--example">
                        <div class="saved-chat--example__title">
                          <span>Draft of rules for new equipment</span>
                        </div>
                        <div class="saved-chat--example__icons">
                          <span><i class="fa-solid fa-share-nodes fa-xl"></i></span>
                          <span><i class="fa-solid fa-gear fa-xl"></i></span>
                          <span class="thrash_icon"><i class="fa-solid fa-trash fa-xl"></i></span>
                        </div>
                      </div><!-- END OF SAVED CHAT EXAMPLE -->
                    </div>
                  </div>
                  <div id="tabs-content-3" class="tabs-panel__tabs-content">
                    <div class="tab-content__wrapper tab-3-debug">
                      <!-- START OF KNOWLEDGE PANEL -->
                      <div class="accordion knowledge-panel__title">
                        <span>Chemistry - Monthly subscription</span>
                        <div class="knowledge--example__icons">
                          <div class="caret__wrapper"><span><i class="fa-solid fa-caret-down"></i></span></div>
                        </div>
                      </div>
                      <div class="panel">
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                      </div><!-- END OF KNOWLEDGE PANEL -->
                      <!-- START OF KNOWLEDGE PANEL -->
                      <div class="accordion knowledge-panel__title">
                        <span>How to use this AI</span>
                        <div class="knowledge--example__icons">
                          <div class="caret__wrapper"><span><i class="fa-solid fa-caret-down"></i></span></div>
                        </div>
                      </div>
                      <div class="panel">
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                      </div><!-- END OF KNOWLEDGE PANEL -->
                      <!-- START OF KNOWLEDGE PANEL -->
                      <div class="accordion knowledge-panel__title">
                        <span>Lorem - ipsum</span>
                        <div class="knowledge--example__icons">
                          <div class="caret__wrapper"><span><i class="fa-solid fa-caret-down"></i></span></div>
                        </div>
                      </div>
                      <div class="panel">
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                      </div><!-- END OF KNOWLEDGE PANEL -->
                      <!-- START OF KNOWLEDGE PANEL -->
                      <div class="accordion knowledge-panel__title">
                        <span>Lorem - ipsum</span>
                        <div class="knowledge--example__icons">
                          <div class="caret__wrapper"><span><i class="fa-solid fa-caret-down"></i></span></div>
                        </div>
                      </div>
                      <div class="panel">
                        <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                      </div><!-- END OF KNOWLEDGE PANEL -->
                    </div>
                  </div>
                  <div id="tabs-content-4" class="tabs-panel__tabs-content">
                    <p>TAB CONTENT 4</p>
                  </div>
                </div>
              </div>
            </div><!-- END OF TABS CONTAINER -->
  </div>


  <!-- ENDS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <!-- ENDS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <!-- ENDS LEFT PANEL WITH TAB BASED NAVIGATION -->
  <!-- ENDS LEFT PANEL WITH TAB BASED NAVIGATION -->




  <!-- STARTS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <!-- STARTS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <!-- STARTS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <!-- STARTS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <div id="chat-screen__right-half" class="flex flex-auto flex-col justify-start items-center font-sans h-screen">
  
  <!-- Actual chat -->
  <!-- START OF CHAT DIALOGUE / WEBSOCKET CONTAINER -->
  <div id="webSocket" class="w-2/5 flex flex-col justify-start items-start pt-2 mb-5">
    <!-- DIALOGUE -->
    <div id="webSocketOutput" class="w-full min-w-full"></div>
    <input class="w-full w-full py-[10px] flex-grow md:py-4 md:pl-4 relative border border-black/10 bg-white dark:border-gray-900/50 dark:text-white dark:bg-gray-700 rounded-xl shadow-xs dark:shadow-xs" id="webSocketInput" class="text-black" type="text" placeholder="Send..." autofocus>

    <!-- END OF DIALOGUE WRAPPER -->
  </div><!--END OF CHAT DIALOGUE /WEBSOCKET CONTAINER -->

  </div>
  <!-- ENDS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <!-- ENDS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <!-- ENDS RIGHT PANEL WITH CHAT AND CLIENT INFO -->
  <!-- ENDS RIGHT PANEL WITH CHAT AND CLIENT INFO -->

  <!-- Javascript code for the frontend -->
  <script>
    // While rawling right now it just adds a text, in the future we would need a progress bar
    const crawlFrom = document.getElementById('crawlForm');
    crawlFrom.addEventListener('submit', (event) => {
      const textNode = document.createElement('p');
      textNode.innerHTML = 'Please wait until we process your URL...';
      const targetNode = document.getElementById('chatControl');
      targetNode.appendChild(textNode)
    });

    const hostname = <%- JSON.stringify(data.hostname) %>

    // Create sock instance
    const ws = new WebSocket(`ws://${hostname}`);

    // Collect data from backend and put in text format.
    const userData = <%- JSON.stringify(data.user) %>;

    // Handle events once conn is established
    // Not of any use right now, but let it be
    ws.onopen = () => {
      console.log('We got a connection');

    };

    // Handle close event, not of any use right now.
    ws.onclose = () => {
      console.log('Connection closed');
    };

    // Defining scrolldown functionality
    const container = document.getElementById("webSocketOutput");
    function scrollDown() {
      container.scrollTop = container.scrollHeight;
    }

    // Get ouput
    const webSocketOutput = document.getElementById('webSocketOutput');

    // Handling received messages via websocket
    ws.onmessage = (event) => {
      let message = event.data;
      console.log('Msg received:', message);
      console.log(JSON.parse(message));
      message = JSON.parse(message);
      let content = message.data.response.content;
      content = content.split('\n');
      content = content.map((line) => {
        return '<p class="w-full">' + line + '</p>';}).join('');
      webSocketOutput.innerHTML += '\
        <div class="machine_message rendered_message p-2  py-2 w-full min-w-full flex flex-row justify-start items-start pt-2 \
        text-gray-900 dark:text-gray-100 border-b border-black/10  dark:text-white dark:bg-gray-700 \
        ">\
          <div class="chat__user-icon--wrapper p-0.5 mr-1 w-9 rounded mr-1 flex flex-row justify-center items-center">\
            <img src="/images/eurofins_logo_2.png">\
          </div>\
          <div class="chat__user-text--wrapper p-1 w-full">\
            <p class=" leading-relaxed w-full">' + content + '</p>\
            <p class=" leading-relaxed w-full"> Here are some links related that you could find useful: ' +  '<a href="' + message.data.urls[0] + '"  style="color: lightblue" target="_blank">' +  message.data.urls[0] + '</a>, ' + '<a href="' +  message.data.urls[1] + '" style="color: lightblue" target="_blank">' + message.data.urls[1] + '</a>' + '<br>' + '</p>\
          </div>\
        </div>';
        scrollDown();
    };

    // Handling sent messages via websocket
    const webSocketInput = document.getElementById('webSocketInput');
    webSocketInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        const text = webSocketInput.value.trim();
        if (text !== '') {
          const msg = {
            origin: userData.handler,
            debug: true,
            data: text,
          }
          ws.send(JSON.stringify(msg));
          webSocketOutput.innerHTML += '\
            <div class="user_message rendered_message p-2 w-full min-w-full flex flex-row justify-start items-start pt-2 \
            w-full py-[10px] flex-grow md:py-4 md:pl-4 relative border border-black/10 dark:border-gray-900/50 bg-gray-900 shadow-xs dark:shadow-xs \
            "> \
              <div class="chat__user-icon--wrapper p-0.5 mr-1 w-9 bg-gray-700 rounded mr-1 flex flex-row justify-center items-center">\
                <img src="/images/user_tem_icon2.png">\
              </div>\
              <div class="chat__user-text--wrapper p-1 w-full">\
                <p class=" w-full">' + msg.data + '</p>\
              </div>\
            </div>';
            /* I'm not happy with the aesthetic result, so I commented it
              <div class="chat__user-icon--wrapper p-0.5 mr-1 w-9 bg-blue-700 rounded mr-1 flex flex-row justify-center items-center">\
                <span class="">You </span>\
              </div>\
            */
          webSocketInput.value = '';
          scrollDown();
        }
      }
    });
  </script>
  <!-- this script controls the tabs in the user menu, replace it wherever it fits whenever the frontend gets refactored -->
  <script>
    function openTab(tabName) {
      console.log(tabName);
      console.log(event.target);
      targetTab = event.target;
      console.log("Event target is");
      console.log(targetTab);

      if(targetTab.tagName == "SPAN" || targetTab.tagName == "I"){
        var newTarget = targetTab.parentElement;
        console.log("new target is");
        console.log(newTarget);
        if(newTarget.tagName == "SPAN" || newTarget.tagName == "I"){
          var newTarget = newTarget.parentElement;
        }

        targetTab = newTarget;
        console.log("last target is");
        console.log(newTarget);
      }

      var i;
      var x = document.getElementsByClassName("tabs-panel__tabs-content");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }

      var y = document.getElementsByClassName("tabs-panel__tab");
      for (i = 0; i < y.length; i++) {
        y[i].classList.remove("isSelectedTab");
      }

      var selectedTab = document.getElementById(tabName);
      selectedTab.style.display = "block";
      targetTab.classList.add("isSelectedTab");

    }
  </script>
  <script>
    var menuVisible = true;

    function showMenu(){
      var optionsMenu = document.getElementById("chat-screen__left-half");
      var unfoldIconContainer = document.getElementById("unfold__accordion-icon__container");
      var cogIcon = document.getElementById("unfold_accordion_icon--close");
      var closeIcon = document.getElementById("unfold_accordion_icon--open");

      if (menuVisible === true){
        console.log("true");
        menuVisible = false;
        optionsMenu.classList.add("hideMenu");
        optionsMenu.classList.remove("showMenu");

        cogIcon.classList.add("hideMenu");
        closeIcon.classList.remove("hideMenu");

        unfoldIconContainer.classList.remove("unfold__accordion-icon__container--unfolded");
        unfoldIconContainer.classList.add("unfold__accordion-icon__container--folded");
      }else{
        console.log("false");
        menuVisible = true;
        optionsMenu.classList.remove("hideMenu");
        optionsMenu.classList.add("showMenu");

        cogIcon.classList.remove("hideMenu");
        closeIcon.classList.add("hideMenu");

        unfoldIconContainer.classList.remove("unfold__accordion-icon__container--folded");
        unfoldIconContainer.classList.add("unfold__accordion-icon__container--unfolded");
      }
    }
  </script>

<script>
  var acc = document.getElementsByClassName("accordion");
  var i;
  
  for (i = 0; i < acc.length; i++) {
    acc[i].addEventListener("click", function() {
      this.classList.toggle("active");
      var panel = this.nextElementSibling;
      if (panel.style.display === "block") {
        panel.style.display = "none";
      } else {
        panel.style.display = "block";
      }
    });
  }
  </script>
</body>
</html>
